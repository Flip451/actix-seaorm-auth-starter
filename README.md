# actix-seaorm-auth-starter

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åŸå‰‡ã«åŸºã¥ãã€**Rust (Actix Web)** ã¨ **SeaORM** ã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã•ã‚ŒãŸã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

## ğŸš€ ç‰¹å¾´

* **Clean Architecture**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„DBæŠ€è¡“ã‹ã‚‰åˆ†é›¢ã—ã€ä¾å­˜é–¢ä¿‚ã‚’ä¸€æ–¹å‘ã«ä¿ã¡ã¾ã™ã€‚
* **Secure Auth**: `Argon2` ã«ã‚ˆã‚‹å …ç‰¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã¨ã€`JWT` (JSON Web Token) ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
* **Production Ready**: Dockerç’°å¢ƒã€OpenTelemetry (Jaeger) ã«ã‚ˆã‚‹åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã€æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å®Œå‚™ã—ã¦ã„ã¾ã™ã€‚
* **Type Safe**: SeaORM ã«ã‚ˆã‚‹å‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã¨ã€Rustã®å‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ï¼ˆValue Objectç­‰ï¼‰ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
* **Developer Experience**: `Makefile` ã«ã‚ˆã‚‹é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è‡ªå‹•åŒ–ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ç”Ÿæˆã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã‚’æä¾›ã—ã¾ã™ã€‚

## ğŸ“… å®Ÿè£…æ©Ÿèƒ½

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ãã€ç¾åœ¨ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

### èªè¨¼ (Auth)

* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² (`Signup`)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»Emailã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã€‚
* **ãƒ­ã‚°ã‚¤ãƒ³ (`Login`)**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ã€JWTãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ (User)

* **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‚ç…§**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®æƒ…å ±å–å¾—ã€‚
* **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ã€‚
  * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´æ™‚ã¯çŠ¶æ…‹ãŒ `ActiveWithUnverifiedEmail` ç­‰ã¸é·ç§»ã—ã¾ã™ã€‚
* **çŠ¶æ…‹ç®¡ç†**: æœªæ¤œè¨¼ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€åœæ­¢ã€é€€ä¼šãªã©ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®Ÿè£…ã€‚

### ç®¡ç†è€… (Admin)

* **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—**: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã€‚
* **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ©ç”¨åœæ­¢**: æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢ï¼ˆSuspendï¼‰ã€‚
  * è‡ªåˆ†è‡ªèº«ã‚„ä»–ã®ç®¡ç†è€…ã‚’åœæ­¢ã§ããªã„èªå¯ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ã‚’å«ã¿ã¾ã™ã€‚

## ğŸ— ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆ

ä¾å­˜é–¢ä¿‚ã®ãƒ«ãƒ¼ãƒ«ï¼ˆDependency Ruleï¼‰ã«å¾“ã„ã€å¤–å´ã‹ã‚‰å†…å´ã¸ã®ã¿ä¾å­˜ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | å½¹å‰² |
| --- | --- | --- |
| **Domain** | `src/domain` | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |
| **UseCase** | `src/usecase` | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆServiceï¼‰ |
| **Infrastructure** | `src/infrastructure` | æŠ€è¡“çš„è©³ç´°ï¼ˆDBå®Ÿè£…/SeaORMã€JWTã€Argon2ãªã©ï¼‰ |
| **API (Interface)** | `src/api` | HTTPãƒãƒ³ãƒ‰ãƒ©ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ› |
| **Main** | `src/main.rs` | DIï¼ˆä¾å­˜æ€§ã®æ³¨å…¥ï¼‰ã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã€æ§‹æˆ |

## ğŸ›  ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å®Ÿè¡Œ

### å‰ææ¡ä»¶

* Docker & Docker Compose
* Make

### 1. ç’°å¢ƒè¨­å®š

`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
cp .env.example .env
```

### 2. ãƒ“ãƒ«ãƒ‰ã¨èµ·å‹•

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œç’°å¢ƒã¨DBæ“ä½œãƒ„ãƒ¼ãƒ«ï¼ˆSeaORM CLIï¼‰ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¾ã™ã€‚

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ„ãƒ¼ãƒ«ã®ãƒ“ãƒ«ãƒ‰
make build
make build-tools

# ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• (App, DB, Jaeger)
make up

# DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ï¼ˆåˆå›èµ·å‹•æ™‚å¿…é ˆï¼‰
make migrate-up
```

èµ·å‹•å¾Œã€APIã‚µãƒ¼ãƒãƒ¼ã¯ `http://localhost:8080` ã§å¾…æ©Ÿã—ã¾ã™ã€‚Jaeger UIã¯ `http://localhost:16686` ã§ç¢ºèªã§ãã¾ã™ã€‚

## ğŸ“¡ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆå®šç¾© ã«åŸºã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ã§ã™ã€‚

| æ©Ÿèƒ½ | ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èªè¨¼ | èª¬æ˜ |
| --- | --- | --- | --- | --- |
| **ç™»éŒ²** | `POST` | `/auth/signup` | ä¸è¦ | æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ |
| **ãƒ­ã‚°ã‚¤ãƒ³** | `POST` | `/auth/login` | ä¸è¦ | JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ |
| **è‡ªåˆ†ã®æƒ…å ±** | `GET` | `/users/me` | **å¿…é ˆ** | è‡ªèº«ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã™ |
| **æƒ…å ±æ›´æ–°** | `PATCH` | `/users/me` | **å¿…é ˆ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»Emailã‚’æ›´æ–°ã—ã¾ã™ |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§** | `GET` | `/admin/users` | **Admin** | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ |
| **åˆ©ç”¨åœæ­¢** | `POST` | `/admin/users/{id}/suspend` | **Admin** | æŒ‡å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ©ç”¨åœæ­¢ã«ã—ã¾ã™ |

> **Note**: èªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã« `Authorization: Bearer <token>` ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

## ğŸ’» é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

`Makefile` ã«å®šç¾©ã•ã‚ŒãŸä¸»è¦ãªã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
| --- | --- |
| `make watch` | ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ã§ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œï¼ˆé–‹ç™ºç”¨ï¼‰ |
| `make test` | ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ |
| `make logs` | ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ã®è¡¨ç¤º |
| `make db-shell` | DBã‚³ãƒ³ãƒ†ãƒŠã« `psql` ã§æ¥ç¶š |
| `make migrate-generate name=<name>` | æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ |
| `make migrate-up` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ |
| `make generate-entity` | DBã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰SeaORMã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‡ªå‹•ç”Ÿæˆ |

## ğŸ“ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

* **Language**: Rust (Edition 2024)
* **Web Framework**: Actix Web
* **Database**: PostgreSQL 15
* **ORM**: SeaORM
* **Auth**: Argon2 (Password Hashing), jsonwebtoken (JWT)
* **Observability**: Tracing, OpenTelemetry, Jaeger
* **Error Handling**: thiserror, anyhow
* **Validation**: validator crate
