# actix-seaorm-auth-starter

ãƒ˜ã‚­ã‚µã‚´ãƒŠãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆPorts and Adaptersï¼‰ã¨é–¢æ•°å‹ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼ˆFunctional DDDï¼‰ã®åŸå‰‡ã«åŸºã¥ãã€**Rust (Actix Web)** ã¨ **SeaORM** ã‚’ä½¿ç”¨ã—ã¦æ§‹ç¯‰ã•ã‚ŒãŸã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ‡ã‚£ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

## ğŸš€ æ ¸å¿ƒçš„ãªç‰¹å¾´

* **Hexagonal Architecture**: ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚’å®Œå…¨ã«ç‹¬ç«‹ã•ã›ã€å¤–éƒ¨ä¾å­˜ï¼ˆDBã€APIã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼‰ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã¨ã—ã¦åˆ†é›¢ã€‚
* **Functional DDD**: çŠ¶æ…‹é·ç§»ã‚’ä»£æ•°çš„ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆEnumï¼‰ã§è¡¨ç¾ã—ã€ä¸æ­£ãªçŠ¶æ…‹ã‚’å‹ã‚·ã‚¹ãƒ†ãƒ ã§æ’é™¤ã€‚
* **Transactional Outbox Pattern**: DBæ›´æ–°ã¨ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œã‚’åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§è¡Œã„ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã® `Relay Worker` ãŒç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’é…é€ã€‚
* **Policy-based Authorization**: èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã€Œãƒãƒªã‚·ãƒ¼ã€ã¨ã—ã¦å®šç¾©ã—ã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ãŸå³å¯†ãªæ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿç¾ã€‚
* **Type Safe Development**: `derive_entity` ãƒã‚¯ãƒ­ã«ã‚ˆã‚‹è­˜åˆ¥å­ãƒ™ãƒ¼ã‚¹ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å®šç¾©ã¨ã€Value Objectã«ã‚ˆã‚‹å¼·åŠ›ãªå‹å®‰å…¨æ€§ã®ç¢ºä¿ã€‚
* **Production Ready Observability**: OpenTelemetry (Jaeger) ã«ã‚ˆã‚‹åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã¨æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å®Œå‚™ã€‚
* **Auto-generated API Docs**: `utoipa` ã«ã‚ˆã‚‹ OpenAPI (Swagger) ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹•ç”Ÿæˆã€‚

## ğŸ— ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

ä¾å­˜é–¢ä¿‚ã¯å¤–å´ã‹ã‚‰å†…å´ï¼ˆDomainï¼‰ã¸ã®ã¿å‘ã‹ã„ã¾ã™ã€‚

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | å†…å®¹ã¨å½¹å‰² |
| :--- | :--- | :--- |
| **Domain** | `libs/domain` | ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ãƒãƒªã‚·ãƒ¼ã€ãƒªãƒã‚¸ãƒˆãƒªTrait |
| **UseCase** | `libs/usecase` | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ­ãƒ¼ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ |
| **Infrastructure** | `libs/infrastructure` | æŠ€è¡“çš„ãªè©³ç´°å®Ÿè£…ï¼ˆSeaORM, Argon2, Email, Clockï¼‰ |
| **API** | `libs/api` | HTTPã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¤‰æ› |
| **Relay** | `libs/relay` | ã‚¢ã‚¦ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šæœŸçš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã—é…é€ã™ã‚‹ãƒ¯ãƒ¼ã‚«ãƒ¼ |
| **App** | `app/` | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã€DIï¼ˆä¾å­˜æ€§ã®æ³¨å…¥ï¼‰ |
| **Macros** | `libs/domain_macros` | ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å®šç¾©ã‚’è£œåŠ©ã™ã‚‹æ‰‹ç¶šãå‹ãƒã‚¯ãƒ­ |

## ğŸ“… å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½

### 1. é«˜åº¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã¨èªè¨¼

* **èªè¨¼**: Argon2ã«ã‚ˆã‚‹ãƒãƒƒã‚·ãƒ¥åŒ–ã¨ã€JWTã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹èªè¨¼ã€‚
* **ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ï¼ˆPending, Active, Suspended, Deactivatedï¼‰ã‚’å‹å®‰å…¨ã«ç®¡ç†ã€‚
* **ä¸å¤‰çš„ãªãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«**: ã€Œç®¡ç†è€…ã¯ä»–ã®ç®¡ç†è€…ã‚’åœæ­¢ã§ããªã„ã€ã€Œè‡ªåˆ†è‡ªèº«ã‚’åœæ­¢ã§ããªã„ã€ãªã©ã®ãƒãƒªã‚·ãƒ¼ã€‚

### 2. ä¿¡é ¼æ€§ã®é«˜ã„ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•

* **ã‚¢ã‚¦ãƒˆãƒœãƒƒã‚¯ã‚¹**: `UserCreated`, `EmailChanged` ãªã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«DBã¸è¨˜éŒ²ã€‚
* **ãƒªãƒ¬ãƒ¼ãƒ¯ãƒ¼ã‚«ãƒ¼**: å¤±æ•—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹å†è©¦è¡Œã‚„ãƒãƒƒãƒå‡¦ç†ã€‚

## ğŸ“¡ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆå®šç¾©ã«åŸºã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§ã§ã™ã€‚

### èªè¨¼ (Auth)
| æ©Ÿèƒ½ | ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èªè¨¼ | èª¬æ˜ |
| --- | --- | --- | --- | --- |
| **ç™»éŒ²** | `POST` | `/auth/signup` | ä¸è¦ | æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ |
| **ãƒ­ã‚°ã‚¤ãƒ³** | `POST` | `/auth/login` | ä¸è¦ | JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¾ã™ |

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ (Users)
| æ©Ÿèƒ½ | ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èªè¨¼ | èª¬æ˜ |
| --- | --- | --- | --- | --- |
| **è‡ªåˆ†ã®æƒ…å ±** | `GET` | `/users/me` | **å¿…é ˆ** | è‡ªèº«ã®è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã™ |
| **å…¬é–‹ãƒ—ãƒ­ãƒ•** | `GET` | `/users/{id}/profile` | **å¿…é ˆ** | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¬é–‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¾ã™ |
| **ãƒ—ãƒ­ãƒ•æ›´æ–°** | `PATCH` | `/users/{id}/profile` | **å¿…é ˆ** | ãƒ¦ãƒ¼ã‚¶ãƒ¼åãªã©ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ |
| **Emailæ›´æ–°** | `PATCH` | `/users/{id}/email` | **å¿…é ˆ** | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›´æ–°ã—ã¾ã™ |

### ç®¡ç†è€… (Admin)
| æ©Ÿèƒ½ | ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | èªè¨¼ | èª¬æ˜ |
| --- | --- | --- | --- | --- |
| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§** | `GET` | `/admin/users/list` | **Admin** | å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ |
| **åˆ©ç”¨åœæ­¢** | `PATCH` | `/admin/users/{id}/suspend` | **Admin** | æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‡çµã—ã¾ã™ |

> **Note**: èªè¨¼ãŒå¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã« `Authorization: Bearer <token>` ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

## ğŸ›  ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. ç’°å¢ƒæ§‹ç¯‰

`.env.example` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è¨­å®šã‚’èª¿æ•´ã—ã¾ã™ã€‚

```bash
cp .env.example .env
```

### 2. ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã¨DBåˆæœŸåŒ–

```bash
make build          # ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰
make build-tools    # CLIãƒ„ãƒ¼ãƒ«ã®ãƒ“ãƒ«ãƒ‰
make up             # App, DB, Jaegerã®èµ·å‹•
make migrate-up     # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```

### 3. APIã®ç¢ºèª

ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€ä»¥ä¸‹ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

* APIã‚µãƒ¼ãƒãƒ¼: `http://localhost:8080`
* Jaeger (ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°): `http://localhost:16686`

## ğŸ’» é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

`Makefile` ã«å®šç¾©ã•ã‚ŒãŸä¸»è¦ãªã‚³ãƒãƒ³ãƒ‰ã§ã™ã€‚

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
| --- | --- |
| `make watch` | ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ã§ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œï¼ˆé–‹ç™ºç”¨ï¼‰ |
| `make test` | ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ |
| `make logs` | ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ã®è¡¨ç¤º |
| `make db-shell` | DBã‚³ãƒ³ãƒ†ãƒŠã« `psql` ã§æ¥ç¶š |
| `make migrate-generate name=<name>` | æ–°è¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ |
| `make migrate-up` | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨ |
| `make generate-entity` | DBã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰SeaORMã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’è‡ªå‹•ç”Ÿæˆ |

## ğŸ“ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

* **Language**: Rust (Edition 2024+)
* **Framework**: Actix Web
* **ORM**: SeaORM (PostgreSQL)
* **Doc**: utoipa (OpenAPI 3.0)
* **Auth**: jsonwebtoken, argon2
* **Telemetry**: tracing, opentelemetry-jaeger
* **Validation**: validator
